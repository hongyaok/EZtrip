<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ trip.trip_name }} - EZtrip</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/icon.png') }}">
</head>
<body>
    <header>
        <nav class="navbar container">
            <a href="/dashboard" class="logo">
                EZtrip
            </a>
            <div class="user-profile" style="position: relative;">
                <img src="{{ picture }}" alt="Profile" class="profile-pic">
                <span id="userDropdownToggle" style="cursor: pointer;">{{name}} <i class="fas fa-caret-down"></i></span>
                <div id="userDropdownMenu" class="dropdown-menu">
                    <a href="/dashboard" class="dropdown-item" >Dashboard</a>
                    <a href="/create-trip" class="dropdown-item" >Create Trip</a>
                    <a href="/auth/logout" class="dropdown-item" >Logout</a>
                </div>
            </div>
        </nav>
    </header>
    <div class="trip-assistant-container">
        <button id="tripAssistantBtn" class="trip-assistant-btn">
            AI Trip Assistant
        </button>
    </div>
    <main class="container">
        <div class="trip-header">
            <div class="trip-info">
                <h1>{{trip.trip_name}}</h1>
                <div class="trip-meta">
                    <span><i class="map-marker-alt"></i> {{trip.dest}}</span>
                    <span><i class="calendar"></i> {{trip.formatted_start}} - {{trip.formatted_end}}</span>
                    <span><i class="tag"></i> {{trip.theme}}</span>
                    <button class="btn" onclick="showEditModal()" id="edit-trip-btn" title="Edit Trip" style="vertical-align: middle; background-color: white; margin-left: 1rem;">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
                <p class="trip-description">{{trip.desc}}</p>
            </div>
            <div class="trip-actions">
                <button class="btn btn-primary" id="add-location-btn">
                    <i class="plus"></i> Add Location
                </button>
                <button class="btn btn-outline" onclick="showInviteModal()">
                    <i class="fas fa-user-plus"></i> Invite Friends
                </button>
                <button class="btn btn-outline" onclick="showUsersModal()">
                    Participants
                </button>
                <a class="btn btn-outline" id="export-btn" href="{{ url_for('download_file', trip_id=trip.trip_id) }}" download>
                    <i class="download"></i> Export Trip
                </a>
                <button class="btn btn-outline" onclick="showOthersModal()">
                    ...
                </button>
            </div>
        </div>

        <div id="add-location-form" class="add-location-container" style="display: none;" action="/api/locations" method="POST">
            <div class="form-container" action="/api/locations" method="POST">
                <h3>Add New Location</h3>
                <form id="locationForm" action="/api/locations" method="POST">
                    <div class="form-group">
                        <label for="location-search">Search Location:</label>
                        <input type="text" id="location-search" class="form-control" placeholder="Search for a place..." name="location" required>
                        <div id="search-results" class="search-results"></div>
                    </div>
                    <div class="form-group">
                        <label for="location-description">Description:</label>
                        <textarea id="location-description" class="form-control" rows="3" placeholder="Why should we visit this place?" name="description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="location-category">Category:</label>
                        <select id="location-category" class="form-control" name="category" required>
                            <option value="restaurant">Restaurant</option>
                            <option value="attraction">Attraction</option>
                            <option value="accommodation">Accommodation</option>
                            <option value="shopping">Shopping</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="location-start-date">Start Date:</label>
                            <input type="date" id="locationStartDate" class="form-control" name="start_date" required>
                        </div>
                        <div class="form-group">
                            <label for="location-end-date">End Date:</label>
                            <input type="date" id="locationEndDate" class="form-control" name="end_date" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="location-start-time">Start Time:</label>
                            <input type="time" id="locationStartTime" class="form-control" name="start_time" required>
                        </div>
                        <div class="form-group">
                            <label for="location-end-time">End Time:</label>
                            <input type="time" id="locationEndTime" class="form-control" name="end_time" required>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="cancel-location-btn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Location</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="trip-content">
            <div class="top-panels">
                <div class="locations-panel">
                    <div class="panel-header">
                        <h2>Recent Activities</h2>
                        <div class="filter-options">
                            <select id="time-filter" class="form-control">
                                <option value="all">All Time</option>
                                <option value="1">Past Day</option>
                                <option value="3">Past 3 Days</option>
                                <option value="7">Past Week</option>
                                <option value="30">Past Month</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="activities-list" class="activities-list scrollable">
                        {% for log in logs %}
                        <div class="activity-card" data-created-at="{{log.created_at}}">
                            <div class="activity-header">
                                <div class="activity-info">
                                    <h4>{{log.name}}</h4>
                                    <span class="category-badge category-{{log.category}}">{{log.category.title()}}</span>
                                </div>
                                <div class="activity-time">
                                    <small class="time-ago" data-created-at="{{log.created_at}}"></small>
                                </div>
                            </div>
                            <div class="activity-content">
                                <p class="activity-description">
                                    <strong>{{log.suggested_by}}</strong>
                                    {% if log.action == 'removed' %}
                                        <strong style="color: red;">{{log.action}}</strong>
                                    {% elif log.action == 'voted for' %}
                                        <strong style="color: green;">{{log.action}}</strong>
                                    {% else %}
                                        {{log.action}}
                                    {% endif %}
                                    this location
                                </p>
                                <p class="location-description">{{log.description}}</p>
                                {% if log.date %}
                                <div class="scheduled-info">
                                    <i class="fas fa-calendar"></i> Scheduled for {{log.date}}
                                    {% if log.start_time %}
                                        at {{log.start_time}}
                                        {% if log.end_time %} - {{log.end_time}}{% endif %}
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if not logs %}
                        <div class="no-activities">
                            <p>No recent activities to show.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="map-panel">
                    <div class="map-section">
                        <h3>Trip Map</h3>
                        <div id="map" class="trip-map"></div>
                    </div>
                </div>
            </div>

            <div class="itinerary-panel">
                <div class="itinerary-header">
                    <h3>Trip Itinerary</h3>
                    <div class="itinerary-filters">
                        <select id="day-filter" class="form-control">
                            <option value="all">All Days</option>
                            {% for date, day_data in itinerary.items() %}
                            <option value="{{date}}">{{date}}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline btn-small" id="optimize-route-btn" onclick="showOptimizeModal()">
                            <i class="fas fa-route"></i> Optimize Route
                        </button>
                    </div>
                </div>
                
                <div id="itinerary-content" class="itinerary-timetable">
                    {% for date, day_data in itinerary.items() %}
                    <div class="day-section" data-date="{{date}}">
                        <div class="day-header">
                            <h4>{{date}}</h4>
                            <span class="activity-count">{{day_data.activities|length}} activities</span>
                        </div>
                        <div class="day-timeline">
                            {% for activity in day_data.activities %}
                            <div class="timeline-item" data-activity-id="{{activity.id}}">
                                <div class="timeline-time">
                                    {% if activity.start_time %}
                                        <span class="start-time">{{activity.start_time}}</span>
                                        {% if activity.end_time %}
                                        <span class="end-time">{{activity.end_time}}</span>
                                        {% endif %}
                                        <span class="end-time">( {{activity.end_date}} )</span>
                                    {% else %}
                                        <span class="no-time">No time set</span>
                                    {% endif %}
                                </div>
                                <div class="timeline-content">
                                    <div class="activity-info">
                                        <h5>{{activity.name}}</h5>
                                        <span class="category-badge category-{{activity.category}}">{{activity.category.title()}}</span>
                                    </div>
                                    <p class="activity-description">{{activity.description}}</p>
                                    <div class="route-info" id="route-info-{{activity.id}}" style="display: none;"></div>
                                    <div class="activity-meta">
                                        <small>Suggested by <strong>{{activity.suggested_by}}</strong></small>

                                        <div class="activity-buttons" style="margin-top: 10px;">
                                            <button class="btn btn-outline btn-small locate-btn"
                                                    style="background: #007bff; color: white; margin-right: 5px"
                                                    data-lat="{{activity.lat}}"
                                                    data-lng="{{activity.lng}}"
                                                    data-name="{{activity.name}}">
                                                <i class="fas fa-map-marker-alt"></i> Locate
                                            </button>
                                            <button class="btn btn-outline btn-small comment-btn" data-activity-id="{{activity.id}}">
                                                <i class="fas fa-comments"></i> Comment
                                            </button>
                                            <form action="/{{activity.trip_id}}/remove/{{activity.id}}" method="POST" style="display: inline;">
                                                <button class="btn btn-outline btn-small remove-btn" style="background: #dc3545; color: white" type="submit">
                                                    <i class="fas fa-trash"></i> Remove   
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not itinerary %}
                    <div class="no-itinerary">
                        <p>No activities scheduled yet. Add some locations to get started!</p>
                    </div>
                    {% endif %}
                </div>

                <div class="itinerary-header">
                    <h3>Conflicts</h3>
                    <div class="itinerary-filters">
                        <select id="day-filter" class="form-control">
                            <option value="all">All Days</option>
                            {% for date in conflicts|map(attribute='date')|unique %}
                            <option value="{{date}}">{{date}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div id="itinerary-content" class="itinerary-timetable">
                    {% for date in conflicts|map(attribute='date')|unique %}
                    {% set day_conflicts = conflicts|selectattr('date', 'equalto', date)|list %}
                    <div class="day-section" data-date="{{date}}">
                        <div class="day-header">
                            <h4>{{date}}</h4>
                            <span class="activity-count">{{day_conflicts|length}} conflicts</span>
                        </div>
                        <div class="day-timeline">
                            {% for conflict in day_conflicts %}
                            <div class="timeline-item conflict-item" data-activity-id="{{conflict.id}}">
                                <div class="timeline-time">
                                    {% if conflict.start_time %}
                                        <span class="start-time">{{conflict.start_time}}</span>
                                        {% if conflict.end_time %}
                                        <span class="end-time">{{conflict.end_time}}</span>
                                        <span class="end-time">( {{conflict.end_date}} )</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="no-time">No time set</span>
                                    {% endif %}
                                </div>
                                <div class="timeline-content">
                                    <div class="activity-info">
                                        <h5>{{conflict.name}}</h5>
                                        <span class="category-badge category-{{conflict.category}}">{{conflict.category.title()}}</span>
                                        <span class="conflict-badge">CONFLICT</span>
                                    </div>
                                    <p class="activity-description">{{conflict.description}}</p>
                                    <small>Suggested by <strong>{{conflict.suggested_by}}</strong></small>
                                    <form action="/{{conflict.trip_id}}/vote/{{conflict.id}}" method="POST">
                                        <button class="vote-button">
                                            <i class="fas fa-thumbs-up"></i> Upvote
                                        </button>
                                        <small class="vote-count">
                                            Currently <strong style="color: red;">{{conflict.votes}}</strong> votes
                                        </small>
                                    </form>
                                    <a class="activity-meta" href="/{{conflict.trip_id}}/remove/{{conflict.id}}">
                                        <button class="btn btn-outline btn-small remove-btn" style="background: #dc3545; color: white" type="submit">
                                            <i class="fas fa-trash"></i> Remove   
                                        </button>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not conflicts %}
                    <div class="no-itinerary">
                        <p>No conflicts detected. Your itinerary looks good!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>

    <!-- modals/popups start here -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="container">
                <h3>Confirm Removal</h3>
                <p>Are you sure you want to remove this location from your trip?</p>
                <div class="clearfix">
                    <button type="button" class="cancelbtn" onclick="closeDeleteModal()">Cancel</button>
                    <button type="button" class="deletebtn" onclick="confirmDelete()">Remove</button>
                </div>
            </div>
        </div>
    </div>
    <div id="tripAssistantModal" class="modal" style="display: none;">
        <div class="modal-content chat-modal">
            <div class="modal-header">
                <h3><i class="fas fa-robot"></i> Trip Assistant</h3>
                <span class="close" id="closeChatModal">&times;</span>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Ask me anything about your trip..." maxlength="500">
                    <button id="sendChatBtn" type="button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="inviteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="container">
                <h3>Invite Friends to Trip</h3>
                <p>Enter email addresses separated by commas</p>
                <form id="inviteForm" action="/api/trips/invite/{{ trip.trip_id }}" method="POST">
                    <div class="form-group">
                        <label for="friend-emails">Email Addresses:</label>
                        <textarea id="friend-emails" name="friend_emails" class="form-control" rows="4" 
                                placeholder="john@eztrip.com, sarah@eztrip.com, mike@eztrip.com" 
                                required></textarea>
                        <small class="form-text">Separate multiple email addresses with commas</small>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-outline" onclick="copyText('{{ trip.trip_id }}')">
                            <i class="fas fa-copy"></i> Copy Invite Link
                        </button>
                    </div>
                    <div class="clearfix">
                        <button type="button" class="cancelbtn" onclick="closeInviteModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Invitations</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="usersModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="container">
                <h3>Trip Participants</h3>
                <p>Here are the users who are part of this trip:</p>
                <ul class="user-list">
                    {% for user in users %}
                    <li>{{ user }}</li>
                    {% endfor %}
                </ul>
                <div class="clearfix">
                    <button type="button" class="cancelbtn" onclick="closeUsersModal()">Ok</button>
                </div>
            </div>
        </div>
    </div>
    <div id="othersModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="container">
                <div class="clearfix">
                    <a class="btn btn-outline" style="background: #dc3545; color: rgb(255, 255, 255);" onclick="showLeaveModal()">
                        <i class="leave"></i> Leave Trip
                    </a>
                    <a class="btn btn-outline" style="background: #1900ff; color: rgb(255, 255, 255);" href="https://forms.gle/A6qVK2o65Dsa7kpcA">
                        <i class="edit"></i> Report an Issue
                    </a>
                </div>
                <div class="clearfix">
                    <button type="button" class="cancelbtn" onclick="closeOthersModal()">Back</button>
                </div>
            </div>
        </div>
    </div>
    <div id="leaveModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="container">
                <h3>Are you sure?</h3>
                <p>Are you sure you want to leave this trip? You will no longer have access to its itinerary and activities. You will need to get a friend to add you back!</p>
                <form id="leaveTripForm" action="/{{ trip.trip_id }}/leave" method="POST">
                    <div class="clearfix">
                        <button type="button" class="btn btn-outline" onclick="closeLeaveModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Leave Trip</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="editModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="container">
                <h3>Edit Trip: {{ trip.trip_name }}</h3>
                <form id="editTripForm" action="/{{ trip.trip_id }}/edit" method="POST">
                    <div class="form-group">
                        <label for="destination">Destination:</label>
                        <input type="text" id="destination" name="destination" class="form-control" value="{{ trip.dest }}">
                    </div>
                    <div class="form-group">
                        <label for="theme">Trip Theme:</label>
                        <select id="theme" name="theme" class="form-control">
                            <option value="" disabled>Select a theme</option>
                            <option value="adventure" {% if trip.theme == 'adventure' %}selected{% endif %}>Adventure</option>
                            <option value="relaxation" {% if trip.theme == 'relaxation' %}selected{% endif %}>Relaxation</option>
                            <option value="food" {% if trip.theme == 'food' %}selected{% endif %}>Food Tour</option>
                            <option value="other" {% if trip.theme == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="form-group date-group">
                        <div class="date-input">
                            <label for="start-date">Start Date:</label>
                            <input type="date" id="start-date" name="start_date" class="form-control" value="{{ trip.start_date[:10] }}">
                        </div>
                        <div class="date-input">
                            <label for="end-date">End Date:</label>
                            <input type="date" id="end-date" name="end_date" class="form-control" value="{{ trip.end_date[:10] }}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea id="description" name="description" rows="4" class="form-control">{{ trip.desc }}</textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="container">
                <h3>Error</h3>
                <p>Start time must be before end time. Please check your input and try again.</p>
                <div class="clearfix">
                    <button type="button" class="btn btn-outline" onclick="closeAlertModal()">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="commentModal" class="modal" style="display: none;">
        <div class="modal-content chat-modal">
            <div class="container">
                <h3 style="margin-top: 1rem;">Comments</h3>
                <div id="commentMessages" class="chat-messages" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; padding: 10px; margin-top: 1rem;">
                </div>
                <form id="commentForm">
                    <input type="hidden" id="commentActivityId" name="activity_id" value="">
                    <div class="form-group">
                        <input type="text" id="commentInput" class="form-control" placeholder="Type your comment..." required>
                    </div>
                    <div class="clearfix">
                        <button type="button" class="btn btn-outline" onclick="closeCommentModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="successModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="container">
                <h3>Success!</h3>
                <p>Your location has been added successfully.</p>
                <div class="clearfix">
                    <button type="button" class="btn btn-outline" onclick="window.location.reload()">Ok</button>
                </div>
            </div>
        </div>
    </div>


    <div id="optimizeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="container">
                <h3>Optimize Trip Routes</h3>
                <p>Find the best transportation methods between your scheduled locations</p>
                <div id="transportFilters"></div>
                <div id="optimizeLoadingSection" class="optimize-loading" style="display: none;">
                    <p>Optimizing your routes...</p>
                    <p>This may take a moment while we search for the best paths</p>
                </div>

                <div id="optimizeErrorSection" class="optimize-error" style="display: none;">
                    <p>Sorry, we couldn't optimize your routes, Please try again.</p>
                </div>

                <div class="clearfix">
                    <button type="button" class="cancelbtn" onclick="closeOptimizeModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="startOptimization()">Optimize Routes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- scripts start here -->
    <script src="{{url_for('static', filename='js/map.js')}}"></script>
    <script src="{{url_for('static', filename='js/route-optimizer.js')}}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcAD8dYx5U0BQDDaJDcwgyf5ir0A11Cr8&libraries=places,geometry&callback=initMap"></script>
    <script>

    document.addEventListener('DOMContentLoaded', function() {
        const toggle = document.getElementById('userDropdownToggle');
        const menu = document.getElementById('userDropdownMenu');
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        });
        document.addEventListener('click', function() {
            menu.style.display = 'none';
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const tripAssistantBtn = document.getElementById('tripAssistantBtn');
        const tripAssistantModal = document.getElementById('tripAssistantModal');
        const closeChatModal = document.getElementById('closeChatModal');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatMessages = document.getElementById('chatMessages');
        
        let chatHistory = [];
        let isFirstMessage = true;

        tripAssistantBtn.addEventListener('click', function() {
            tripAssistantModal.style.display = 'flex';
            if (isFirstMessage) {
                initializeChat();
                isFirstMessage = false;
            }
            chatInput.focus();
        });

        closeChatModal.addEventListener('click', function() {
            tripAssistantModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === tripAssistantModal) {
                tripAssistantModal.style.display = 'none';
            }
        });

        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        sendChatBtn.addEventListener('click', sendMessage);

        function initializeChat() {
            const tripDestination = '{{ trip.dest }}';
            
            fetch('/api/chat/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    trip_id: '{{ trip.trip_id }}',
                    location: tripDestination
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessageToChat(data.message, 'assistant');
                }
            })
            .catch(error => {
                console.error('Error initializing chat:', error);
                addMessageToChat('We are currently facing difficulties, please try again later.', 'assistant');
            });
        }

        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            addMessageToChat(message, 'user');
            chatHistory.push({role: 'user', content: message});
            
            chatInput.value = '';
            
            showTypingIndicator();

            fetch('/api/chat/reply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    trip_id: '{{ trip.trip_id }}',
                    location: '{{ trip.dest }}',
                    chat_history: chatHistory
                })
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                if (data.success) {
                    addMessageToChat(data.message, 'assistant');
                    chatHistory.push({role: 'assistant', content: data.message});
                } else {
                    addMessageToChat('We are currently facing difficulties, please try again later.', 'assistant');
                }
            })
            .catch(error => {
                hideTypingIndicator();
                console.error('Error sending message:', error);
                addMessageToChat('We are currently facing difficulties, please try again later.', 'assistant');
            });
        }

        function addMessageToChat(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${sender}`;
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
    });


    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.comment-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
            const activityId = this.getAttribute('data-activity-id');
            document.getElementById('commentActivityId').value = activityId;
            document.getElementById('commentModal').style.display = 'flex';
            loadComments(activityId);
            });
        });

        document.getElementById('commentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const activityId = document.getElementById('commentActivityId').value;
            const comment = document.getElementById('commentInput').value.trim();
            if (!comment) return;

            fetch(`/api/activities/${activityId}/comments`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ comment })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('commentInput').value = '';
                loadComments(activityId);
            })
            .catch(err => alert('Failed to post comment.'));
        });

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('commentModal');
            if (event.target === modal) closeCommentModal();
        });
    });

    function loadComments(activityId) {
        const commentMessages = document.getElementById('commentMessages');
        commentMessages.innerHTML = '<em>Loading...</em>';
        fetch(`/api/activities/${activityId}/comments`)
            .then(response => response.json())
            .then(comments => {
                if (!comments.length) {
                    commentMessages.innerHTML = '<p style="color: #888;">No comments yet.</p>';
                    return;
            }
            commentMessages.innerHTML = comments.map(c =>
                `<div class="chat-bubble">
                <strong>${c.username}:</strong> ${c.comment}
                <div style="font-size: 0.8em; color: #aaa;">${new Date(c.created_at).toLocaleString()}</div>
                </div>`
            ).join('');
            commentMessages.scrollTop = commentMessages.scrollHeight;
            });
    }

    function closeCommentModal() {
        document.getElementById('commentModal').style.display = 'none';
        document.getElementById('commentMessages').innerHTML = '';
    }


    function showAlertModal() {
        document.getElementById('alertModal').style.display = 'flex';
    }

    function closeAlertModal() {
        document.getElementById('alertModal').style.display = 'none';
    }

    document.getElementById('locationForm').addEventListener('submit', function(e) {
        e.preventDefault(); 

        const startDate = document.getElementById('locationStartDate').value;
        const endDate = document.getElementById('locationEndDate').value;
        const startTime = document.getElementById('locationStartTime').value;
        const endTime = document.getElementById('locationEndTime').value;


        const startDateTime = new Date(`${startDate}T${startTime}`);
        const endDateTime = new Date(`${endDate}T${endTime}`);
        const tripStartDateTime = new Date("{{ trip.start_date[:10] }}T00:00");
        const tripEndDateTime = new Date("{{ trip.end_date[:10] }}T23:59");

        // console.log("{{ trip.end_date[:10] }}T23:59")
        // console.log('Start DateTime:', startDateTime, 
        //               'End DateTime:', endDateTime,
        //               'Trip Start DateTime:', tripStartDateTime,
        //               'Trip End DateTime:', tripEndDateTime);

        if (startDateTime < tripStartDateTime || endDateTime > tripEndDateTime) {
            showAlertModal();
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Add Location';
            return;
        }

        else if (endDateTime < startDateTime) {
            showAlertModal();
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Add Location';
            return;
        }

        else if (startDateTime < tripStartDateTime || startDateTime > tripEndDateTime) {
            showAlertModal();
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Add Location';
            return;
        }

        else if (endDateTime < tripStartDateTime || endDateTime > tripEndDateTime) {
            showAlertModal();
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Add Location';
            return;
        }


        if (isNaN(startDateTime) || isNaN(endDateTime)) {
            showAlertModal();
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Add Location';
            return;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn.disabled) return;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';


        let lat = null;
        let lng = null;

         if (window.currentPreviewPlace && window.currentPreviewPlace.geometry) {
            lat = window.currentPreviewPlace.geometry.location.lat();
            lng = window.currentPreviewPlace.geometry.location.lng();
            console.log('Found coordinates from search:', lat, lng)
        } else {
            console.log('No currentPreviewPlace found:', window.currentPreviewPlace);
        }

        const formData = {
            name: document.getElementById('location-search').value,
            category: document.getElementById('location-category').value,
            description: document.getElementById('location-description').value,
            start_date: document.getElementById('locationStartDate').value,
            end_date: document.getElementById('locationEndDate').value,
            start_time: document.getElementById('locationStartTime').value,
            end_time: document.getElementById('locationEndTime').value,
            trip_id: "{{ trip.trip_id }}",
            lat: lat,
            lng: lng
        };

        console.log('Form data being sent - lat:', lat, 'lng:', lng)

        fetch('/api/locations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            if (data.success && data.location) {
                createPermanentMarker(data.location.lat, data.location.lng, data.location.name, data.location.id);
                
                window.location.reload();
            } else {
                console.error('Location data missing:', data);
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding location.Please try again');
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const timeFilter = document.getElementById('time-filter');
        
        function updateTimeAgo() {
            const timeElements = document.querySelectorAll('.time-ago');
            timeElements.forEach(element => {
                const createdAt = element.getAttribute('data-created-at');
                const timeAgo = getTimeAgo(createdAt);
                element.textContent = timeAgo;
            });
        }
        
        function getTimeAgo(dateString) {
            const now = new Date();
            const created = new Date(dateString);
            const diffInSeconds = Math.floor((now - created) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + ' min ago';
            if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + ' hr ago';
            return Math.floor(diffInSeconds / 86400) + ' day ago';
        }  
        
        function filterActivitiesByTime(days) {
            const activityCards = document.querySelectorAll('.activity-card');
            const now = new Date();
            
            activityCards.forEach(card => {
                const createdAt = new Date(card.getAttribute('data-created-at'));
                const daysDiff = (now - createdAt) / (1000 * 60 * 60 * 24);
                
                if (days === 'all' || daysDiff <= parseInt(days)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        const dayFilter = document.getElementById('day-filter');
        
        function filterItineraryByDay(selectedDate) {
            const daySections = document.querySelectorAll('.day-section');
            
            daySections.forEach(section => {
                const sectionDate = section.getAttribute('data-date');
                
                if (selectedDate === 'all' || sectionDate === selectedDate) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }
        
        if (dayFilter) {
            dayFilter.addEventListener('change', function() {
                filterItineraryByDay(this.value);
            });
        }
        
        if (timeFilter) {
            timeFilter.addEventListener('change', function() {
                filterActivitiesByTime(this.value);
            });
        }
        
        updateTimeAgo();
        
        setInterval(updateTimeAgo, 10);
    });

    let currentDeleteForm = null;

    function showDeleteModal(form) {
        currentDeleteForm = form;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        currentDeleteForm = null;
    }

    function confirmDelete() {
        if (currentDeleteForm) {
            currentDeleteForm.submit();
        }
        closeDeleteModal();
    }

    function showInviteModal() {
        document.getElementById('inviteModal').style.display = 'flex';
    }

    function closeInviteModal() {
        document.getElementById('inviteModal').style.display = 'none';
        document.getElementById('friend-emails').value = '';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const inviteForm = document.getElementById('inviteForm');
        if (inviteForm) {
            inviteForm.addEventListener('submit', function(e) {
                const emailInput = document.getElementById('friend-emails');
                const emailString = emailInput.value.trim();
                
                if (!emailString) {
                    e.preventDefault();
                    alert('Please enter at least one email address.');
                    return;
                }
            });
        }
        window.addEventListener('click', function(event) {
            const inviteModal = document.getElementById('inviteModal');
            if (event.target === inviteModal) {
                closeInviteModal();
            }
        });
    });

    function showUsersModal(form) {
        document.getElementById('usersModal').style.display = 'flex';
    }

    function closeUsersModal() {
        document.getElementById('usersModal').style.display = 'none';
    }

    function showOthersModal(form) {
        document.getElementById('othersModal').style.display = 'flex';
    }

    function closeOthersModal() {
        document.getElementById('othersModal').style.display = 'none';
    }

    function showEditModal(form) {
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    function showLeaveModal(form) {
        document.getElementById('leaveModal').style.display = 'flex';
    }

    function closeLeaveModal() {
        document.getElementById('leaveModal').style.display = 'none';
    }

    function copyText(id) {
        navigator.clipboard.writeText
            ("https://eztrip-vbi5.onrender.com/join/" + id);
        alert("Copied to clipboard!");
    }

    </script>

</body>
</html>